<!DOCTYPE html>
<html lang="en" xmlns:v-bind="http://xmlns.jcp.org/jsf/html">
<head>
    <meta charset="utf-8">
    <title>聊天室</title>
    <link rel="shortcut icon" type="image/x-icon" href="dist/images/favicon.png">
    <style>
        * {
            box-sizing: border-box;
        }
        *:before, *:after {
            box-sizing: inherit;
        }
        body, html {
            height: 100%;
            overflow: hidden;
        }
        body, ul {
            margin: 0;
            padding: 0;
        }
        body {
            color: #4d4d4d;
            font: 14px/1.4em 'Helvetica Neue', Helvetica, 'Microsoft Yahei', Arial, sans-serif;
            background: #f5f5f5 url('dist/images/bg.jpg') no-repeat center;
            background-size: cover;
            font-smoothing: antialiased;
        }
        ul {
            list-style: none;
        }

        .button {
            position: relative;
            top: -70px;
            left: 680px;
            border-radius: 10px;
            background-color: #eeeeee;
            border: none;
            color: #606060;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 1px;
            margin: 4px 2px;
            cursor: pointer;
            outline:none;
        }
        .button:hover{
            background-color: #129611;
            color: white;
        }
        .sendName{
            font-family: "Arial";
            font-size: 10px;
            color: #b2b2b2;
        }
    </style>

    <style type="text/css">#app[_v-6f58f7a2]{margin:20px auto;width:800px;height:600px;overflow:hidden;border-radius:3px}#app .main[_v-6f58f7a2],#app .sidebar[_v-6f58f7a2]{height:100%}#app .sidebar[_v-6f58f7a2]{float:left;width:200px;color:#f4f4f4;background-color:#2e3238}#app .main[_v-6f58f7a2]{position:relative;overflow:hidden;background-color:#eee}#app .text[_v-6f58f7a2]{width:100%;bottom:0;left:0}#app .message[_v-6f58f7a2]{height:calc(100% - 160px)}</style><style type="text/css">.card[_v-7021c5b7]{padding:12px;border-bottom:1px solid #24272c}.card footer[_v-7021c5b7]{margin-top:10px}.card .avatar[_v-7021c5b7],.card .name[_v-7021c5b7]{vertical-align:middle}.card .avatar[_v-7021c5b7]{border-radius:2px}.card .name[_v-7021c5b7]{display:inline-block;margin:0 0 0 15px;font-size:16px}.card .search[_v-7021c5b7]{padding:0 10px;width:100%;font-size:12px;color:#fff;height:30px;line-height:30px;border:1px solid #3a3a3a;border-radius:4px;outline:none;background-color:#26292e}</style><style type="text/css">.list li[_v-7e56f776]{padding:12px 15px;border-bottom:1px solid #292c33;cursor:pointer;-webkit-transition:background-color .1s;transition:background-color .1s}.list li[_v-7e56f776]:hover{background-color:hsla(0,0%,100%,.03)}.list li.active[_v-7e56f776]{background-color:hsla(0,0%,100%,.1)}.list .avatar[_v-7e56f776],.list .name[_v-7e56f776]{vertical-align:middle}.list .avatar[_v-7e56f776]{border-radius:2px}.list .name[_v-7e56f776]{display:inline-block;margin:0 0 0 15px}</style><style type="text/css">.text[_v-34cd3954]{height:160px;border-top:1px solid #ddd}.text textarea[_v-34cd3954]{padding:10px;height:100%;width:100%;border:none;outline:none;font-family:Micrsofot Yahei;resize:none}</style><style type="text/css">.message[_v-b412eea0]{padding:10px 15px;overflow-y:scroll}.message li[_v-b412eea0]{margin-bottom:15px}.message .time[_v-b412eea0]{margin:7px 0;text-align:center}.message .time>span[_v-b412eea0]{display:inline-block;padding:0 18px;font-size:12px;color:#fff;border-radius:2px;background-color:#dcdcdc}.message .avatar[_v-b412eea0]{float:left;margin:0 10px 0 0;border-radius:3px}.message .text[_v-b412eea0]{display:inline-block;position:relative;padding:0 10px;max-width:calc(100% - 40px);min-height:30px;line-height:2.5;font-size:12px;text-align:left;word-break:break-all;background-color:#fafafa;border-radius:4px}.message .text[_v-b412eea0]:before{content:" ";position:absolute;top:9px;right:100%;border:6px solid transparent;border-right-color:#fafafa}.message .self[_v-b412eea0]{text-align:right}.message .self .avatar[_v-b412eea0]{float:right;margin:0 0 0 10px}.message .self .text[_v-b412eea0]{background-color:#b2e281}.message .self .text[_v-b412eea0]:before{right:inherit;left:100%;border-right-color:transparent;border-left-color:#b2e281}</style></head>

</head>
<body>

<!-- 总页面 -->
<div id="app" _v-6f58f7a2>
    <!-- 显示个人信息 + 在线信息列表 -->
    <div class="sidebar" _v-6f58f7a2>
        <!-- 显示个人信息 -->
        <div class="card" _v-7021c5b7 _v-6f58f7a2>
            <header _v-7021c5b7>
                <img class="avatar" onclick="f.click()" width="40" height="40" _v-7021c5b7="" alt="请设置头像" style="cursor: pointer" title="点击设置头像" :src="url">
                <p class="name" _v-7021c5b7>{{sendName}}</p>
            </header>
            <footer _v-7021c5b7>
                <input class="search" type="text" v-model.trim="searchVal" placeholder="搜索用户..." _v-7021c5b7>
            </footer>
        </div>
        <!-- 显示聊天信息 -->
        <div class="list" _v-7e56f776 _v-6f58f7a2 >
            <ul _v-7e56f776>
                <li _v-7e56f776 @click="onAcquireName('在线群聊')" v-bind:class="{active: '在线群聊' == receiveName}">
                    <img src="dist/images/all.png" _v-7e56f776 class="avatar" width="30" height="30" alt="">
                    <p class="name" _v-7e56f776>在线群聊</p>
                </li>
                <li _v-7e56f776 v-for="user of searchList":key="user.name":class="{active: user.name == receiveName}" @click="onAcquireName(user.name)">
                    <img :src="user.url" _v-7e56f776 class="avatar" width="30" height="30" alt="">
                    <p class="name" _v-7e56f776>{{user.name}}</p>
                </li>
            </ul>
        </div>
    </div>
    <!-- 聊天页面 -->
    <div class="main" _v-6f58f7a2>
        <div>
            <h5 class="name" style="text-align: center; color: black; font-family: Arial">{{receiveName}}</h5>
        </div>
        <div class="message" id="scrollIV" _v-b412eea0 _v-6f58f7a2>
            <ul _v-b412eea0>
                <li _v-b412eea0 v-for="item of message">
                    <p class="time" _v-b412eea0 v-if="item.createDate">
                        <span _v-b412eea0>{{item.createDate}}</span>
                    </p>
                    <div class="main" v-bind:class="{ self: item.sendName == sendName}" _v-b412eea0>
                        <p class="sendName" v-if="item.receiveName == '在线群聊' && item.sendName != sendName">{{item.sendName}}</p>
                        <img class="avatar" _v-b412eea0 width="30" height="30" :src="item.url" alt="">
                        <div class="text" v-html="item.text" _v-b412eea0></div>
                    </div>
                </li>
            </ul>
        </div>
        <!-- 发送信息内容 -->
        <div class="text" _v-34cd3954 _v-6f58f7a2 >
            <textarea placeholder="按 Ctrl + Enter 发送" @keyup.ctrl.enter="send()"  _v-34cd3954 name="" v-model="text" id="" cols="30" rows="10">
            </textarea>
        </div>
    </div>
    <button class="button" @click="send()">发送</button>

    <form method="post" action="/upload" name="upload" enctype="multipart/form-data">
        <input id="f" type="file" v-on:change="chooseImg(this)" name="file" style="display: none"><br>
        <input type="hidden" name="sendName" v-model="sendName"><br>
    </form>
</div>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/store.js/1.3.20/store.js"></script>
<script src="dist/js/jquery.js"></script>
<script src="dist/js/jquery.cookie.js"></script>
<script>
   let app =  new Vue({
        el: '#app',
        data: {
            path: 'ws://127.0.0.1:8080/websocket',
            socket: null,
            message: [],
            sendName: '',
            receiveName: '',
            text: '',
            userCount: [],
            searchVal: '',
            url: ''
        },mounted (){
           this.sendName = $.cookie("sendName")
           this.url = '/img/'+ this.sendName + ".jpg"
           this.init()
       },methods: {
           init() {
               if(typeof(WebSocket) === "undefined"){
                   alert("您的浏览器不支持socket")
               }else{
                   // 实例化socket
                   this.socket = new WebSocket(this.path)
                   // 监听socket连接
                   this.socket.onopen = this.open
                   // 监听socket错误信息
                   this.socket.onerror = this.error
                   // 监听socket消息
                   this.socket.onmessage = this.getMessage
               }

           },
           open() {
               console.log("socket连接成功")
               if (this.sendName != ""){
                   this.socket.send(JSON.stringify({sendName:this.sendName,type:"setting"}))
               }
           },
           error() {
               console.log("连接错误")
           },
           getMessage(msg) {
                console.log(msg.data)
               let parse = JSON.parse(msg.data);
               console.log(parse)
               if(parse.type == "userCount"){
                   this.userCount = parse.userCount
                   return
               } else if(parse.sendName == this.receiveName && parse.receiveName != "在线群聊" && parse.sendName != this.sendName){
                   this.message.push(parse)
               }else if(parse.receiveName == "在线群聊" && this.receiveName == parse.receiveName){
                   this.message.push(parse)
                   let messageList = [];
                   let chatData = store.get("在线群聊")
                   if(chatData != null){
                       messageList = chatData.message;
                       messageList.push(parse)
                   }
                   store.set("在线群聊", {message: messageList});
                   this.nextTick()
                   return;
               }else if(parse.receiveName == "在线群聊" && this.receiveName != parse.receiveName){
                   let chatData = store.get("在线群聊")
                   let messageList = [];
                   if(chatData != null){
                       messageList = chatData.message;
                       messageList.push(parse)
                   }
                   store.set("在线群聊", {message: messageList});
                   this.nextTick()
                   return;
               }
               this.nextTick()
               let sendName = parse.sendName;
               if(this.sendName == sendName) return;
               let messageList = [];
               let chat = store.get(sendName);
               if (chat != null) {
                   messageList = chat.message;
                   messageList.push(parse)
               }
               store.set(sendName, {message: messageList});

           },
           send() {
               if (this.sendName == "" || this.sendName == null){
                   alert("请设置昵称")
                   this.sendName = prompt("昵称：");
                   if(this.sendName == "在线群聊") return;
                   $.cookie("sendName",this.sendName,{expires:7,path:"/"})
                   let json = JSON.stringify({sendName:this.sendName,type:"setting"});
                   this.socket.send(json)
               } else if (this.text == null || this.text == ""){
                    return;
               } else if(this.receiveName == ""){
                   alert("请指定发送人")
               } else if (this.text.length > 250){
                   alert("长度不能超过250")
               }else {
                   let json = JSON.stringify({
                       text: this.text,
                       type: "message",
                       receiveName: this.receiveName,
                       sendName: this.sendName,
                       url: this.url
                   })
                   this.socket.send(json)
                   this.text = ""
                   if(this.receiveName != "在线群聊"){
                       this.message.push(JSON.parse(json))
                   }
                   store.set(this.receiveName, {message: this.message});
               }
           },
           close() {
               console.log("socket连接关闭")
           },
           onAcquireName : function (name) {
               this.receiveName = name
               this.message = []
               let chat = store.get(this.receiveName);
               if(chat != null){
                   this.message = store.get(this.receiveName).message;
               }else{
                   store.set(this.receiveName, {message: this.message})
               }
               this.$nextTick(function(){
                   let elementById = document.getElementById("scrollIV");
                   elementById.scrollTop = elementById.scrollHeight;
               })
           }, nextTick(){
               this.$nextTick(function(){
                   let elementById = document.getElementById("scrollIV");
                   elementById.scrollTop = elementById.scrollHeight;
               })
           },  chooseImg(file){
                if(file != null && this.sendName != null){
                     document.forms['upload'].submit()
                }
            }
       }, destroyed () {
           // 销毁监听
           this.socket.onclose = this.close
       },computed: {
           searchList: function(){
               return this.userCount.filter((text) => {
                   return text.name.toLowerCase().match(this.searchVal.toLowerCase());
               })
           }
       }
    })
</script>
</body>
</html>
